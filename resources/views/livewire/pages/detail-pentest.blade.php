<?php

use App\Models\Pentest;
use App\Models\PentestVulnerabilities;
use App\Models\PentestReport;
use App\Models\PentestHistory;
use Livewire\Volt\Component;
use Illuminate\Database\Eloquent\Builder;

new class extends Component {
    public Pentest $pentest;

    public string $activeTab = 'overview';
    public array $vulnerabilityStats = [];

    public function mount(int $id): void
    {
        $this->pentest = Pentest::query()
            ->with([
                'aplikasi',
                'penanggungJawab',
                'vulnerabilites' => fn($query) => $query->orderBy('tingkat_risiko', 'desc'),
                'reports',
                'histories' => fn($query) => $query->with('penanggungJawab')->latest()
            ])
            ->findOrFail($id);

        $this->vulnerabilityStats = PentestVulnerabilities::query()
            ->selectRaw('tingkat_risiko, COUNT(*) as count')
            ->where('pentest_id', $id)
            ->groupBy('tingkat_risiko')
            ->pluck('count', 'tingkat_risiko')
            ->toArray();
    }

    public function changeTab(string $tab): void
    {
        $this->activeTab = $tab;
    }
}; ?>

<div class="p-4 space-y-6">
    
    <!-- Navigasi breadcrumb -->
    <div class="mb-6">
        <flux:breadcrumbs>
            <flux:breadcrumbs.item href="#">Pentest</flux:breadcrumbs.item>
            <flux:breadcrumbs.item href="{{ route('pentest-list') }}">Detail</flux:breadcrumbs.item>
            <flux:breadcrumbs.item href="{{ request()->url() }}">{{ $pentest->aplikasi->nama_aplikasi ?? 'Tidak Ada' }}</flux:breadcrumbs.item>
        </flux:breadcrumbs>
    </div>

    <!-- Header -->
    <div class="bg-white rounded-xl border border-gray-200 shadow-sm overflow-hidden">
        <div class="relative h-48 bg-gradient-to-r from-red-500 to-orange-600 flex items-center justify-center">
            <div class="absolute inset-0 bg-black opacity-20"></div>
            <div class="relative z-10 text-center p-6">
                <h1 class="text-3xl font-bold text-white">{{ $pentest->aplikasi->nama_aplikasi ?? 'Tidak Ada' }}</h1>
                <p class="text-white mt-2">Ringkasan Penetration Test</p>
                <div class="flex justify-center mt-4 space-x-3">
                    <span class="px-4 py-1 text-sm font-medium rounded-full 
                        {{ $pentest->status === 'Selesai' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800' }}">
                        {{ $pentest->status }}
                    </span>
                    <span class="px-4 py-1 text-sm font-medium rounded-full bg-blue-100 text-blue-800">
                        {{ $pentest->metode }}
                    </span>
                    <span class="px-4 py-1 text-sm font-medium rounded-full bg-purple-100 text-purple-800">
                        {{ $pentest->tingkat }}
                    </span>
                </div>
            </div>
        </div>

        <!-- Navigasi Tab -->
        <div class="border-b border-gray-200">
            <nav class="flex -mb-px">
                <button wire:click="changeTab('overview')" 
                    class="{{ $activeTab === 'overview' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }} whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-info-circle mr-2"></i>Ringkasan
                </button>
                <button wire:click="changeTab('vulnerabilities')" 
                    class="{{ $activeTab === 'vulnerabilities' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }} whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-shield-virus mr-2"></i>Kerentanan
                </button>
                <button wire:click="changeTab('reports')" 
                    class="{{ $activeTab === 'reports' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }} whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-file-alt mr-2"></i>Laporan
                </button>
                <button wire:click="changeTab('history')" 
                    class="{{ $activeTab === 'history' ? 'border-blue-500 text-blue-600' : 'border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300' }} whitespace-nowrap py-4 px-6 border-b-2 font-medium text-sm">
                    <i class="fas fa-history mr-2"></i>Riwayat
                </button>
            </nav>
        </div>

        <!-- Konten Tab -->
        <div class="p-6">
            <!-- Tab Ringkasan -->
            @if($activeTab === 'overview')
            <div class="space-y-6">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <!-- Kolom Kiri -->
                    <div class="md:col-span-2 space-y-6">
                        <!-- Info Dasar -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-calendar-alt text-blue-500 mr-2"></i> Jadwal Pentest
                            </h2>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Tanggal Mulai</h3>
                                    <p class="mt-1 text-lg font-medium">{{ $pentest->tanggal_mulai }}</p>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Tanggal Selesai</h3>
                                    <p class="mt-1 text-lg font-medium">{{ $pentest->tanggal_selesai }}</p>
                                </div>
                            </div>
                        </div>

                        <!-- Statistik Kerentanan -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-chart-pie text-purple-500 mr-2"></i> Statistik Kerentanan
                            </h2>
                            <div class="space-y-4">
                                @foreach(['Critical', 'High', 'Medium', 'Low'] as $level)
                                    <div>
                                        <div class="flex justify-between mb-1">
                                            <span class="text-sm font-medium text-gray-700">{{ $level }}</span>
                                            <span class="text-sm text-gray-500">{{ $vulnerabilityStats[$level] ?? 0 }}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2.5">
                                            <div 
                                                class="h-2.5 rounded-full" 
                                                @class([
                                                    'bg-red-600' => $level === 'Critical',
                                                    'bg-orange-500' => $level === 'High',
                                                    'bg-yellow-400' => $level === 'Medium',
                                                    'bg-green-500' => $level === 'Low',
                                                ])
                                                style="width: {{ (($vulnerabilityStats[$level] ?? 0) / max(array_sum($vulnerabilityStats), 1)) * 100 }}%"
                                            ></div>
                                        </div>
                                    </div>
                                @endforeach
                            </div>
                        </div>
                    </div>

                    <!-- Kolom Kanan -->
                    <div class="space-y-6">
                        <!-- Lingkup & Tujuan -->
                        <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                            <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                                <i class="fas fa-bullseye text-green-500 mr-2"></i> Lingkup & Tujuan
                            </h2>
                            <div class="space-y-4">
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Lingkup Testing</h3>
                                    <p class="mt-1 text-gray-600 whitespace-pre-line">{{ $pentest->scope_testing }}</p>
                                </div>
                                <div>
                                    <h3 class="text-sm font-medium text-gray-500">Tujuan</h3>
                                    <p class="mt-1 text-gray-600 whitespace-pre-line">{{ $pentest->objective }}</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Kesimpulan & Rekomendasi -->
                @if($pentest->kesimpulan || $pentest->rekomendasi)
                <div class="bg-white p-6 rounded-lg border border-gray-200 shadow-sm">
                    <h2 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-clipboard-check text-red-500 mr-2"></i> Kesimpulan & Rekomendasi
                    </h2>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        @if($pentest->kesimpulan)
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Kesimpulan</h3>
                                <p class="mt-1 text-gray-600 whitespace-pre-line">{{ $pentest->kesimpulan }}</p>
                            </div>
                        @endif
                        @if($pentest->rekomendasi)
                            <div>
                                <h3 class="text-sm font-medium text-gray-500">Rekomendasi</h3>
                                <p class="mt-1 text-gray-600 whitespace-pre-line">{{ $pentest->rekomendasi }}</p>
                            </div>
                        @endif
                    </div>
                </div>
                @endif
            </div>
            @endif

            <!-- Tab Kerentanan -->
            @if($activeTab === 'vulnerabilities')
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-shield-virus text-purple-500 mr-2"></i> Daftar Kerentanan
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kerentanan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tingkat Risiko</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Lokasi</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @forelse($pentest->vulnerabilites as $vulnerability)
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">{{ $vulnerability->nama_kerentanan }}</div>
                                        <div class="text-sm text-gray-500">{{ Str::limit($vulnerability->deskripsi, 50) }}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <span @class([
                                            'px-2 inline-flex text-xs leading-5 font-semibold rounded-full',
                                            'bg-red-100 text-red-800' => $vulnerability->tingkat_risiko === 'Critical',
                                            'bg-orange-100 text-orange-800' => $vulnerability->tingkat_risiko === 'High',
                                            'bg-yellow-100 text-yellow-800' => $vulnerability->tingkat_risiko === 'Medium',
                                            'bg-green-100 text-green-800' => $vulnerability->tingkat_risiko === 'Low',
                                        ])>
                                            {{ $vulnerability->tingkat_risiko }}
                                        </span>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ Str::limit($vulnerability->lokasi, 30) }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ $vulnerability->status }}</td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Tidak ada kerentanan yang ditemukan</td>
                                </tr>
                            @endforelse
                        </tbody>
                    </table>
                </div>
            </div>
            @endif

            <!-- Tab Laporan -->
            @if($activeTab === 'reports')
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-file-alt text-blue-500 mr-2"></i> Daftar Laporan
                    </h2>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Judul Laporan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nomor Laporan</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Tanggal Terbit</th>
                                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Klasifikasi</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            @forelse($pentest->reports as $report)
                                <tr>
                                    <td class="px-6 py-4 whitespace-nowrap">
                                        <div class="text-sm font-medium text-gray-900">{{ $report->judul_laporan }}</div>
                                    </td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ $report->nomor_laporan }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ $report->tanggal_penerbitan }}</td>
                                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">{{ $report->klasifikasi }}</td>
                                </tr>
                            @empty
                                <tr>
                                    <td colspan="4" class="px-6 py-4 text-center text-sm text-gray-500">Tidak ada laporan yang ditemukan</td>
                                </tr>
                            @endforelse
                        </tbody>
                    </table>
                </div>
            </div>
            @endif

            <!-- Tab Riwayat -->
            @if($activeTab === 'history')
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden">
                <div class="px-6 py-4 border-b border-gray-200">
                    <h2 class="text-xl font-semibold text-gray-800 flex items-center">
                        <i class="fas fa-history text-orange-500 mr-2"></i> Riwayat Perubahan
                    </h2>
                </div>
                <ul class="divide-y divide-gray-200">
                    @forelse($pentest->histories as $history)
                        <li class="px-6 py-4">
                            <div class="flex items-center space-x-3">
                                <div class="flex-shrink-0">
                                    <img class="h-8 w-8 rounded-full" src="{{ $history->user->profile_photo_url ?? '/image.jpg' }}" alt="{{ $history->penanggungJawab->name ?? 'N/A' }}">
                                </div>
                                <div class="flex-1 min-w-0">
                                    <p class="text-sm font-medium text-gray-900 truncate">{{ $history->penanggungJawab->name ?? 'N/A' }}</p>
                                    <p class="text-sm text-gray-500 truncate">{{ $history->aksi }} - {{ $history->created_at->diffForHumans() }}</p>
                                </div>
                                <div class="flex-shrink-0">
                                    <p class="text-sm text-gray-500">{{ $history->created_at->format('d M Y H:i') }}</p>
                                </div>
                            </div>
                            @if($history->deskripsi_perubahan)
                                <div class="mt-2 ml-11">
                                    <p class="text-sm text-gray-500">{{ $history->deskripsi_perubahan }}</p>
                                </div>
                            @endif
                        </li>
                    @empty
                        <li class="px-6 py-4 text-center text-sm text-gray-500">Tidak ada riwayat yang ditemukan</li>
                    @endforelse
                </ul>
            </div>
            @endif
        </div>

        <!-- Footer -->
        <div class="bg-gray-50 px-6 py-4 border-t border-gray-200 flex justify-between items-center">
            <div class="text-sm text-gray-500">
                Terakhir diperbarui: {{ $pentest->updated_at->format('d M Y H:i') }}
            </div>
            <div class="flex space-x-3">
                <a href="{{ route('pentest-list.edit', $pentest->id) }}" class="inline-flex items-center px-4 py-2 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-edit mr-2"></i> Edit
                </a>
                <button class="inline-flex items-center px-4 py-2 border border-transparent text-sm font-medium rounded-md shadow-sm text-white bg-blue-600 hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                    <i class="fas fa-download mr-2"></i> Ekspor
                </button>
            </div>
        </div>
    </div>
    
</div>